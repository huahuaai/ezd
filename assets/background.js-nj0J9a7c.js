chrome.runtime.onMessage.addListener((e,i,s)=>(e.getDropBtn&&fetch(chrome.runtime.getURL("src/components/dropbtn.html")).then(o=>o.text()).then(o=>{s({drop_btn_string:o})}).catch(o=>console.error(o)),!0));chrome.runtime.onMessage.addListener((e,i,s)=>(e.getSavedCode&&console.log("a"),!0));chrome.runtime.onMessage.addListener((e,i,s)=>(e.opensidepanel&&chrome.tabs.query({active:!0,currentWindow:!0},function(o){console.log(o[0].id);let n=o[0];chrome.sidePanel.open({tabId:n.id})}),!0));const D=/^https:\/\/mp\.weixin\.qq\.com\/cgi-bin\/.*$/;chrome.tabs.onUpdated.addListener(async(e,i,s)=>{if(console.log(e),!s.url)return;const o=new URL(s.url);D.test(o)?await chrome.sidePanel.setOptions({tabId:e,path:"src/sidepanel/index.html",enabled:!0}):await chrome.sidePanel.setOptions({tabId:e,enabled:!1})});chrome.tabs.onActivated.addListener(e=>{chrome.runtime.onConnect.addListener(i=>(i.name==="materialSidePanel"&&(d=i),i.name==="SidePanel"&&(d.postMessage({mspopen:!0}),i.onDisconnect.addListener(()=>{d.postMessage({mspclose:!0})})),!0))});let d=null;chrome.runtime.onConnect.addListener(e=>(e.name==="materialSidePanel"&&(d=e),e.name==="SidePanel"&&(d.postMessage({mspopen:!0}),e.onDisconnect.addListener(()=>{d.postMessage({mspclose:!0})})),!0));let _=null;chrome.runtime.onConnect.addListener(e=>(e.name==="editSidePanel"&&(_=e),e.name==="SidePanel"&&(_.postMessage({espopen:!0}),e.onDisconnect.addListener(()=>{console.log("disconnect"),_.postMessage({espclose:!0})})),!0));chrome.runtime.onMessage.addListener((e,i,s)=>{console.log(e);async function o(){let[n]=await chrome.tabs.query({active:!0,currentWindow:!0});console.log(n.id),console.log(e.savedCode),chrome.scripting.executeScript({target:{tabId:n.id},func:T,args:[e.savedCode]}).then(()=>console.log("inject add code"))}o()});chrome.windows.onRemoved.addListener(function(){chrome.windows.getAll({populate:!1},function(e){e.length===0&&(chrome.storage.local.clear(function(){console.log("本地存储已清空")}),chrome.storage.local.get(null,function(i){console.log(i)}))})});let T=e=>{let i=(t,l)=>{const r=document.createElement("span");r.classList.add("ripple");let c=document.querySelector(".edui-editor-iframeholder"),Y=document.querySelector(".drop_btn_container"),q=document.querySelector("#ueditor_0"),R=(q.contentDocument||q.contentWindow.document).querySelector(".view.rich_media_content.autoTypeSetting24psection");console.log(R),c.style.position="relative",c.style.overflow="hidden",c.append(r);const h=c.getBoundingClientRect(),C=Math.max(h.width,h.height);r.style.width=r.style.height=`${C}px`,r.style.left=`${t.clientX-h.left-C/2}px`,r.style.top=`${t.clientY-h.top-C/2}px`,r.addEventListener("animationend",()=>{R.innerHTML=l,Y.remove(),r.remove()})};console.log(e);let s=`<div class="drop_btn_container" style="pointer-events: all;width: 22px;height: 22px;background-color: #007AFF;padding: 14px;margin: 0;border-radius: 25px; display: flex;align-items: center;justify-content: center;">
      <svg width="15" height="22" style="pointer-events: none;" viewBox="0 0 16 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.99414 21.3008C6.54232 21.2943 5.27279 20.9948 4.18555 20.4023C3.09831 19.8164 2.25195 18.9928 1.64648 17.9316C1.04753 16.8704 0.748047 15.6302 0.748047 14.2109C0.748047 13.5534 0.826172 12.8861 0.982422 12.209C1.14518 11.5254 1.35352 10.8516 1.60742 10.1875C1.86133 9.51693 2.13477 8.88216 2.42773 8.2832C2.77279 7.54753 3.16341 6.80208 3.59961 6.04688C4.04232 5.29167 4.50781 4.53971 4.99609 3.79102C5.48438 3.03581 5.96615 2.29688 6.44141 1.57422C6.66276 1.23568 6.90039 0.985026 7.1543 0.822266C7.41471 0.659505 7.69466 0.578125 7.99414 0.578125C8.29362 0.578125 8.57031 0.659505 8.82422 0.822266C9.08464 0.985026 9.32552 1.23568 9.54688 1.57422C10.0091 2.27734 10.4746 2.99349 10.9434 3.72266C11.4186 4.45182 11.8711 5.18424 12.3008 5.91992C12.737 6.64909 13.1211 7.36849 13.4531 8.07812C13.7656 8.70312 14.0553 9.36068 14.3223 10.0508C14.5957 10.7409 14.8138 11.4375 14.9766 12.1406C15.1458 12.8438 15.2305 13.5339 15.2305 14.2109C15.2305 15.6302 14.9277 16.8704 14.3223 17.9316C13.7233 18.9928 12.8802 19.8164 11.793 20.4023C10.7122 20.9948 9.44596 21.2943 7.99414 21.3008Z" fill="white" fill-opacity="0.5"/>
      </svg>
  </div>`;const o=document.createElement("div");o.innerHTML=s;let n=o.querySelector(".drop_btn_container");n.style.position="fixed",n.style.right="10%",n.style.top="50%",n.style.zIndex="10000",document.body.appendChild(n);let g=document.querySelector(".edui-editor-iframeholder").getBoundingClientRect(),b=g.left,L=g.right,w=g.bottom,x=g.top,f=!1,a,u,m,p,v=0,y=0;const S=()=>{const t=n.getBoundingClientRect(),l=t.left+t.width/2,r=t.top+t.height/2;console.log(l,r,b,L,w,x),l>b&&l<L&&r<w&&r>x?(n.style.cursor="pointer",n.addEventListener("click",c=>{i(c,e)})):n.removeEventListener("click",i)};S();const M=t=>{t.type==="touchstart"?(m=t.touches[0].clientX-v,p=t.touches[0].clientY-y):(m=t.clientX-v,p=t.clientY-y),n.style.cursor="grabbing",t.target===n&&(f=!0)},E=()=>{m=a,p=u,f=!1,n.style.cursor="grab",S()},P=t=>{f&&(t.preventDefault(),t.type==="touchmove"?(a=t.touches[0].clientX-m,u=t.touches[0].clientY-p):(a=t.clientX-m,u=t.clientY-p),v=a,y=u,X(a,u,n))},X=(t,l,r)=>{r.style.transform=`translate3d(${t}px, ${l}px, 0)`};document.addEventListener("touchstart",M,!1),document.addEventListener("touchend",E,!1),document.addEventListener("touchmove",P,!1),document.addEventListener("mousedown",M,!1),document.addEventListener("mouseup",E,!1),document.addEventListener("mousemove",P,!1)};
