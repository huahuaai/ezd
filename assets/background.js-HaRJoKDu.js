chrome.runtime.onMessage.addListener((e,i,o)=>(e.getDropBtn&&fetch(chrome.runtime.getURL("src/components/dropbtn.html")).then(t=>t.text()).then(t=>{o({drop_btn_string:t})}).catch(t=>console.error(t)),!0));chrome.runtime.onMessage.addListener((e,i,o)=>(e.getSavedCode&&console.log("a"),!0));chrome.runtime.onMessage.addListener((e,i,o)=>(e.opensidepanel&&chrome.tabs.query({active:!0,currentWindow:!0},function(t){console.log(t[0].id);let r=t[0];chrome.sidePanel.open({tabId:r.id})}),!0));const q=/^https:\/\/mp\.weixin\.qq\.com\/cgi-bin\/.*$/;chrome.tabs.onUpdated.addListener(async(e,i,o)=>{if(console.log(e),!o.url)return;const t=new URL(o.url);q.test(t)?await chrome.sidePanel.setOptions({tabId:e,path:"src/sidepanel/index.html",enabled:!0}):await chrome.sidePanel.setOptions({tabId:e,enabled:!1})});chrome.tabs.onActivated.addListener(e=>{chrome.runtime.onConnect.addListener(i=>(i.name==="materialSidePanel"&&(d=i),i.name==="SidePanel"&&(d.postMessage({mspopen:!0}),i.onDisconnect.addListener(()=>{d.postMessage({mspclose:!0})})),!0))});let d=null;chrome.runtime.onConnect.addListener(e=>(e.name==="materialSidePanel"&&(d=e),e.name==="SidePanel"&&(d.postMessage({mspopen:!0}),e.onDisconnect.addListener(()=>{d.postMessage({mspclose:!0})})),!0));let b=null;chrome.runtime.onConnect.addListener(e=>(e.name==="editSidePanel"&&(b=e),e.name==="SidePanel"&&(b.postMessage({espopen:!0}),e.onDisconnect.addListener(()=>{console.log("disconnect"),b.postMessage({espclose:!0})})),!0));chrome.runtime.onMessage.addListener((e,i,o)=>{console.log(e);async function t(){let[r]=await chrome.tabs.query({active:!0,currentWindow:!0});console.log(r.id),console.log(e.savedCode),chrome.scripting.executeScript({target:{tabId:r.id},func:R,args:[e.savedCode]}).then(()=>console.log("inject add code"))}t()});chrome.windows.onRemoved.addListener(function(){chrome.windows.getAll({populate:!1},function(e){e.length===0&&(chrome.storage.local.clear(function(){console.log("本地存储已清空")}),chrome.storage.local.get(null,function(i){console.log(i)}))})});let M=(e,i)=>{const o=document.createElement("span");o.classList.add("ripple");let t=document.querySelector(".edui-editor-iframeholder"),r=document.querySelector(".drop_btn_container"),s=document.querySelector("#ueditor_0"),a=(s.contentDocument||s.contentWindow.document).querySelector(".view.rich_media_content.autoTypeSetting24psection");console.log(a),t.style.position="relative",t.style.overflow="hidden",t.append(o);const l=t.getBoundingClientRect(),c=Math.max(l.width,l.height);o.style.width=o.style.height=`${c}px`,o.style.left=`${e.clientX-l.left-c/2}px`,o.style.top=`${e.clientY-l.top-c/2}px`,o.addEventListener("animationend",()=>{a.innerHTML=i,r.remove(),o.remove()})},R=e=>{let i=`<div class="drop_btn_container" style="pointer-events: all;width: 22px;height: 22px;background-color: #007AFF;padding: 14px;margin: 0;border-radius: 25px; display: flex;align-items: center;justify-content: center;">
      <svg width="15" height="22" style="pointer-events: none;" viewBox="0 0 16 22" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.99414 21.3008C6.54232 21.2943 5.27279 20.9948 4.18555 20.4023C3.09831 19.8164 2.25195 18.9928 1.64648 17.9316C1.04753 16.8704 0.748047 15.6302 0.748047 14.2109C0.748047 13.5534 0.826172 12.8861 0.982422 12.209C1.14518 11.5254 1.35352 10.8516 1.60742 10.1875C1.86133 9.51693 2.13477 8.88216 2.42773 8.2832C2.77279 7.54753 3.16341 6.80208 3.59961 6.04688C4.04232 5.29167 4.50781 4.53971 4.99609 3.79102C5.48438 3.03581 5.96615 2.29688 6.44141 1.57422C6.66276 1.23568 6.90039 0.985026 7.1543 0.822266C7.41471 0.659505 7.69466 0.578125 7.99414 0.578125C8.29362 0.578125 8.57031 0.659505 8.82422 0.822266C9.08464 0.985026 9.32552 1.23568 9.54688 1.57422C10.0091 2.27734 10.4746 2.99349 10.9434 3.72266C11.4186 4.45182 11.8711 5.18424 12.3008 5.91992C12.737 6.64909 13.1211 7.36849 13.4531 8.07812C13.7656 8.70312 14.0553 9.36068 14.3223 10.0508C14.5957 10.7409 14.8138 11.4375 14.9766 12.1406C15.1458 12.8438 15.2305 13.5339 15.2305 14.2109C15.2305 15.6302 14.9277 16.8704 14.3223 17.9316C13.7233 18.9928 12.8802 19.8164 11.793 20.4023C10.7122 20.9948 9.44596 21.2943 7.99414 21.3008Z" fill="white" fill-opacity="0.5"/>
      </svg>
  </div>`;const o=document.createElement("div");o.innerHTML=i;let t=o.querySelector(".drop_btn_container");t.style.position="fixed",t.style.right="10%",t.style.top="50%",t.style.zIndex="10000",document.body.appendChild(t);let s=document.querySelector(".edui-editor-iframeholder").getBoundingClientRect(),v=s.left,a=s.right,l=s.bottom,c=s.top,y=!1,u,m,p,g,C=0,_=0;const L=()=>{const n=t.getBoundingClientRect(),h=n.left+n.width/2,f=n.top+n.height/2;console.log(h,f,v,a,l,c),h>v&&h<a&&f<l&&f>c?(t.style.cursor="pointer",t.addEventListener("click",P=>{M(P,e)})):t.removeEventListener("click",M)};L();const w=n=>{n.type==="touchstart"?(p=n.touches[0].clientX-C,g=n.touches[0].clientY-_):(p=n.clientX-C,g=n.clientY-_),t.style.cursor="grabbing",n.target===t&&(y=!0)},x=()=>{p=u,g=m,y=!1,t.style.cursor="grab",L()},S=n=>{y&&(n.preventDefault(),n.type==="touchmove"?(u=n.touches[0].clientX-p,m=n.touches[0].clientY-g):(u=n.clientX-p,m=n.clientY-g),C=u,_=m,E(u,m,t))},E=(n,h,f)=>{f.style.transform=`translate3d(${n}px, ${h}px, 0)`};document.addEventListener("touchstart",w,!1),document.addEventListener("touchend",x,!1),document.addEventListener("touchmove",S,!1),document.addEventListener("mousedown",w,!1),document.addEventListener("mouseup",x,!1),document.addEventListener("mousemove",S,!1)};
