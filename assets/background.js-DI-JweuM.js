chrome.runtime.onMessage.addListener((e,n,o)=>(e.getDropBtn&&fetch(chrome.runtime.getURL("src/components/dropbtn.html")).then(t=>t.text()).then(t=>{o({drop_btn_string:t})}).catch(t=>console.error(t)),!0));chrome.runtime.onMessage.addListener((e,n,o)=>(e.opensidepanel&&chrome.tabs.query({active:!0,currentWindow:!0},function(t){let r=t[0];chrome.sidePanel.open({tabId:r.id})}),!0));const y=/^https:\/\/mp\.weixin\.qq\.com\/cgi-bin\/.*$/;chrome.tabs.onUpdated.addListener(async(e,n,o)=>{if(!o.url)return;const t=new URL(o.url);y.test(t)?await chrome.sidePanel.setOptions({tabId:e,path:"src/sidepanel/index.html",enabled:!0}):await chrome.sidePanel.setOptions({tabId:e,enabled:!1})});chrome.windows.onRemoved.addListener(function(){chrome.windows.getAll({populate:!1},function(e){e.length===0&&(chrome.storage.local.clear(function(){console.log("本地存储已清空")}),chrome.storage.local.get("cachedElementData",function(n){console.log(n)}),m())})});chrome.tabs.onActivated.addListener(()=>{chrome.runtime.sendMessage({loadData:!0})});let u="";chrome.runtime.onMessage.addListener((e,n,o)=>(e.savedCode&&(u=e.savedCode),!0));let d=null,l=null;chrome.runtime.onConnect.addListener(e=>{e.name==="svgcode"&&chrome.runtime.onMessage.addListener((n,o,t)=>(n.savedCode&&e.postMessage({svgcode:n.savedCode}),!0)),e.name==="mmask"&&(d=e),e.name==="emask"&&(l=e)});chrome.runtime.onMessage.addListener((e,n,o)=>{let t,r;return e.openhotzone&&(t={showhotzone:!0,key:e.key,imgurl:e.imgurl,cnt:e.hotzonecnt,hotx:e.hotx,hoty:e.hoty,hotw:e.hotw,hoth:e.hoth},r={closehotzone:!0}),e.freshhotzone&&(t={freshhotzone:!0,key:e.key,imgurl:e.imgurl,cnt:e.hotzonecnt,hotx:e.hotx,hoty:e.hoty,hotw:e.hotw,hoth:e.hoth}),e.closehotzone&&(t={closehotzone:!0,key:e.key}),e.opensvgcanvas&&(t={showsvgcanvas:!0,key:e.key,backgroundinfo:e.backgroundinfo,eldict:e.eldict,keylist:e.keylist},r={closesvgcanvas:!0}),e.freshsvgcanvas&&(e.type==="update"?t={freshsvgcanvas:!0,type:e.type,key:e.key,updatekey:e.updatekey,eldict:e.eldict}:e.type==="add"?t={freshsvgcanvas:!0,type:e.type,key:e.key,addkey:e.addkey,eldict:e.eldict,keylist:e.keylist}:e.type==="remove"&&(t={freshsvgcanvas:!0,type:e.type,key:e.key,removekey:e.removekey})),e.closesvgcanvas&&(t={closesvgcanvas:!0}),e.openaudiohotzone&&(t={showaudiohotzone:!0,key:e.key,backgroundinfo:e.backgroundinfo,hotx:e.hotx,hoty:e.hoty,hotw:e.hotw,hoth:e.hoth}),["openhotzone","freshhotzone","closehotzone","opensvgcanvas","freshsvgcanvas","closesvgcanvas","openaudiohotzone","closeaudiohotzone"].some(c=>c in e)&&chrome.tabs.query({active:!0,currentWindow:!0},function(c){let f=c[0];/https:\/\/mp.weixin.qq.com\/cgi-bin\/appmsg\?t=media\/appmsg_edit.*/.test(f.url)?(l.postMessage(t),d&&d.postMessage(r)):(d.postMessage(t),l&&l.postMessage(r))}),!0});chrome.runtime.onMessage.addListener((e,n,o)=>e.hascode?o({svgcode:u}):!0);chrome.runtime.onMessage.addListener((e,n,o)=>(e.clearcode&&(u=""),!0));let i=null,s=null,a=!1;chrome.runtime.onConnect.addListener(e=>{e.name==="edit_contentjs"?(i=e,i.postMessage({init:!0}),i.onMessage.addListener(function(n,o,t){n.isOpen&&a&&i.postMessage({isopen:!0})})):e.name==="material_contentjs"&&(s=e,s.postMessage({init:!0}),s.onMessage.addListener(function(n,o,t){n.isOpen&&a&&s.postMessage({isopen:!0})})),console.log(i),e.name==="sidepanel"&&(console.log("sidepanel opened"),chrome.tabs.query({active:!0,currentWindow:!0},function(n){let o=n[0];/https:\/\/mp.weixin.qq.com\/cgi-bin\/appmsg\?t=media\/appmsg_edit.*/.test(o.url)?(console.log("nihao"),i.postMessage({open:!0})):s.postMessage({open:!0})}),a=!0,e.onDisconnect.addListener(()=>{a=!1,chrome.tabs.query({active:!0,currentWindow:!0},function(n){let o=n[0];/https:\/\/mp.weixin.qq.com\/cgi-bin\/appmsg\?t=media\/appmsg_edit.*/.test(o.url)?(console.log("nihao"),i.postMessage({close:!0})):s.postMessage({close:!0})})}))});chrome.runtime.onMessage.addListener((e,n,o)=>{e.type==="sidePanelOpened"&&(chrome.tabs.query({active:!0,currentWindow:!0},function(t){let r=t[0];/https:\/\/mp.weixin.qq.com\/cgi-bin\/appmsg\?t=media\/appmsg_edit.*/.test(r.url)?i.postMessage({open:!0}):s.postMessage({open:!0})}),console.log("Side panel is opened"))});let p;async function h(){await chrome.storage.local.set({"last-heartbeat":new Date().getTime()})}async function v(){h().then(()=>{p=setInterval(h,20*1e3)})}v();async function m(){clearInterval(p)}
